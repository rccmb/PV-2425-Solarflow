@using SolarflowClient.Models.Enums
@model HomeViewModel;

@{
    ViewData["Title"] = "Dashboard";


    // Chart House Consumption 
    var chartHouseConsumption = (Model.LastEnergyRecord?.House ?? 0) * -1;

    // Chart Solar Production vs. House Consumption 
    var chartSolarHouseDate = Model.EnergyRecords?.Select(record => record.Timestamp.ToString("dd-MM-yyyy HH:mm")).ToList() ?? [];
    var chartSolarHouseProduction = Model.EnergyRecords?.Select(record => record.Solar > 0 ? record.Solar : 0).ToList() ?? [];
    var chartSolarHouseConsumption = Model.EnergyRecords?.Select(record =>
            (record.Battery < 0 ? record.Battery : 0) +
            (record.Grid < 0 ? record.Grid : 0) +
            record.House)
        .ToList() ?? [];


    var chartConsumptionBattery = Model.EnergyRecords?
        .Select(record => record.Battery > 0.0
            ? record.Battery
            : 0.0
        ).ToList() ?? [];

    var chartConsumptionGrid = Model.EnergyRecords?
        .Select(record => record.Grid > 0.0
            ? record.Grid
            : 0.0
        ).ToList() ?? [];

    var chartConsumptionSolar = Model.EnergyRecords?
        .Select(record =>
        {
            var sum = Math.Min(Math.Abs(record.House), record.Solar);
            return sum > 0 ? Math.Abs(sum) : 0.0;
        }).ToList() ?? [];

    // Chart Battery Level
    var chartBatteryLevel = Model.Battery?.CapacityLevel ?? 0;
    var (chartBatteryBackgroundColor, chartBatteryBorderColor) = chartBatteryLevel switch
    {
        >= 60 => ("rgba(68, 187, 164, 0.6)", "rgba(68, 187, 164, 1)"),
        >= 40 => ("rgba(243, 146, 55, 0.6)", "rgba(243, 146, 55, 1)"),
        _ => ("rgba(219, 83, 117, 0.6)", "rgba(219, 83, 117, 1)")
    };

    // Chart Forecast
    var chartForecastDate = Model.Forecast?.Select(forecast => forecast.ForecastDate.ToString("yy-MM-dd")).ToList() ?? [];
    var chartForecastData = Model.Forecast?.Select(forecast => (int)forecast.SolarHoursExpected).ToList() ?? [];

    // --- Weather Icon Based On First Forecast ---
    var firstForecastDay = Model.Forecast?.FirstOrDefault();
    var firstForecastDayWeather = firstForecastDay?.WeatherCondition ?? "";

    var urlForecastIcon = firstForecastDayWeather switch
    {
        "Partly Cloudy" => "/images/weather/partly_cloudy.png",
        "Cloudy" => "/images/weather/cloudy.png",
        "Very Cloudy" => "/images/weather/very_cloudy.png",
        _ => "/images/weather/clear.png"
    };
}

<!DOCTYPE html>
<html lang="en">
<head>
    <title>Solarflow - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <link rel="stylesheet" href="~/css/dashboard/dashboard.css" asp-append-version="true">
</head>
<body>
<div id="dashboard">

    <!-- Dashboard Header -->
    <div id="dashboard-header">
        <div>
            <h1>@ViewData["Title"]</h1>
            <small>
                Last Update:
                <span id="last-update">
                    @Model.LastEnergyRecord?.Timestamp.ToString("F");
                </span>
            </small>
        </div>
        <div>
            <a href="@Url.Action("Export", "Home", new { Model.Filter.StartDate, Model.Filter.EndDate, Model.Filter.TimeInterval })" id="download-icon" title="Download CSV" download>
                <i class="fas fa-download"></i>
            </a>
        </div>
    </div>


    <!-- Dashboard Charts -->
    <div id="dashboard-charts">
        <div id="dashboard-charts-energy">

            <!-- Current Consumption -->
            @if (Model.LastEnergyRecord != null)

            {
                <div class="chart-item">
                    <h2>Energy Usage</h2>
                    <p>@chartHouseConsumption kWh</p>
                </div>
            }


            <!-- Weather Icon -->
            @if (Model.Forecast != null)
            {
                <div class="chart-item">
                    <h2>Weather Prevision</h2>
                        <img src="@urlForecastIcon" alt="@firstForecastDayWeather" width="100" height="100"/>
                </div>
            }


            <!-- Solar Prevision -->
            @if (Model.Forecast != null)
            {
                <div class="chart-item">
                    <h2>Solar Prevision</h2>
                    <div>
                        <canvas id="chartSolarPrevision"></canvas>
                    </div>
                </div>
            }

            <!-- Battery Status (Percentage) -->
            @if (Model.Battery != null)
            {
                <div class="chart-item">
                    <h2>Battery Status</h2>
                    <canvas id="chartBattery"></canvas>
                </div>
            }

            <div>
                <form asp-action="Index" asp-controller="Home" method="get">
                    <div id="dashboard-filters">
                        <div class="dashboard-filter-item">
                            <label asp-for="Filter.StartDate"></label>
                            <!-- Using the asp-for helper here, although you might need to adjust the format -->
                            <input asp-for="Filter.StartDate" type="datetime-local" class="form-control"/>
                        </div>
                        <div class="dashboard-filter-item">
                            <label asp-for="Filter.EndDate"></label>
                            <input asp-for="Filter.EndDate" type="datetime-local" class="form-control"/>
                        </div>
                        <div class="dashboard-filter-item">
                            <label asp-for="Filter.TimeInterval"></label>
                            <select asp-for="Filter.TimeInterval" class="form-control" asp-items="Html.GetEnumSelectList<TimeInterval>()"></select>
                        </div>
                        <button type="submit" class="btn btn-primary">Apply Filters</button>
                    </div>
                </form>
            </div>

            <!-- Energy Consumption -->
            @if (Model.EnergyRecords != null)
            {
                <div class="chart-item">
                    <h2>Solar Production / House Consumption</h2>
                    <div>
                        <canvas id="chartConsumptionProduction"></canvas>
                    </div>
                </div>
            }

            <!-- Energy Consumption -->
            @if (Model.EnergyRecords != null)
            {
                <div class="chart-item">
                    <h2>Consumption</h2>
                    <div>
                        <canvas id="chartConsumptionStacked"></canvas>
                    </div>
                </div>
            }

        </div>
    </div>
</div>

<!-- Include Chart.js -->
</body>
</html>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script>

        // Chart Battery Level
        @if (Model.Battery != null)
        {
            <text>
                    new Chart(document.getElementById('chartBattery').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Battery'],
                            datasets: [{
                                label: 'Battery Level',
                                data: [@Html.Raw(Json.Serialize(chartBatteryLevel))],
                                backgroundColor: @Html.Raw(Json.Serialize(chartBatteryBackgroundColor)),
                                borderColor: @Html.Raw(Json.Serialize(chartBatteryBorderColor)),
                                borderWidth: 1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100,
                                    ticks: { stepSize: 10 }
                                }
                            }
                        }
                    });
            </text>
        }

        // Chart Solar Production vs. House Consumption
        @if (Model.EnergyRecords != null)
        {
            <text>
            // Chart Consumption vs. Production
                new Chart(document.getElementById('chartConsumptionProduction').getContext('2d'), {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(chartSolarHouseDate)),
                    datasets: [{
                        label: 'Gains',
                        data: @Html.Raw(Json.Serialize(chartSolarHouseProduction)),
                        fill: true,
                        backgroundColor: "rgba(231,187,65, 0.6)",
                        borderColor: "rgba(231,187,65, 1)",
                        borderWidth: 1
                    }, {
                        label: 'Consumption',
                        data: @Html.Raw(Json.Serialize(chartSolarHouseConsumption)),
                        fill: true,
                        backgroundColor: "rgba(57,62,65, 0.6)",
                        borderColor: "rgba(57,62,65, 1)",
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        </text>
        }

        @if (Model.EnergyRecords != null)
        {
            <text>
            // Example: stacked line chart
            new Chart(document.getElementById('chartConsumptionStacked').getContext('2d'), {
                type: 'line',
                data: {
                    labels: @Html.Raw(Json.Serialize(chartSolarHouseDate)), // e.g., timestamps or other x-axis labels
                    datasets: [
                        {
                            label: 'Grid',
                            data: @Html.Raw(Json.Serialize(chartConsumptionGrid)), 
                            fill: true,
                            backgroundColor: "rgba(0, 0, 255, 0.4)",
                            borderColor: "rgba(0, 0, 255, 1)",
                            borderWidth: 1
                        },
                        {
                            label: 'Solar',
                            data: @Html.Raw(Json.Serialize(chartConsumptionSolar)), 
                            fill: true,
                            backgroundColor: "rgba(255, 165, 0, 0.4)",
                            borderColor: "rgba(255, 165, 0, 1)",
                            borderWidth: 1
                        },
                        {
                            label: 'Battery',
                            data: @Html.Raw(Json.Serialize(chartConsumptionBattery)), 
                            fill: true,
                            backgroundColor: "rgba(0, 128, 0, 0.4)",
                            borderColor: "rgba(0, 128, 0, 1)",
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            stacked: true
                        },
                        x: {
                            // optional x-axis config
                        }
                    },
                    plugins: {
                        legend: {
                            display: true // or false if you don't want to show dataset labels
                        }
                    }
                }
            });
            </text>
        }

        // Chart Solar Prevision
        new Chart(document.getElementById('chartSolarPrevision').getContext('2d'), {
            type: 'line',
            data: {
                labels: @Html.Raw(Json.Serialize(chartForecastDate)),
                datasets: [{
                    label: 'Gains',
                    data: @Html.Raw(Json.Serialize(chartForecastData)),
                    fill: true,
                    backgroundColor: "rgba(231,187,65, 0.6)",
                    borderColor: "rgba(231,187,65, 1)",
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                }
            }
        });

    </script>
}